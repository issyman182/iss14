name: ISS14 Build and Deploy

on:
  push:
    branches:
      - release
    tags:
      - '^(release)( )([0-9]+\.[0-9]+\.[0-9]+)$'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4.2.2
      with:
        submodules: 'recursive'
    
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v4.1.0
      with:
        dotnet-version: 9.0.x
      
    - name: Get Engine Tag
      run: |
        cd RobustToolbox
        git fetch --depth=1
    
    - name: Install dependencies
      run: dotnet restore
      
    - name: Build Packaging Tool
      run: dotnet build Content.Packaging --configuration Release

    - name: Package Server
      run: dotnet run --project Content.Packaging server --hybrid-acz --platform linux-x64

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: server-zip
        path: release/SS14.Server_linux-x64.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: server-zip
          path: ./downloaded-artifact

      - name: Create SSH key file
        env:
          SSH_KEY_ED25519: ${{ secrets.SSH_KEY_ED25519 }}
        run: echo "$SSH_KEY_ED25519" > ssh_key && chmod 600 ssh_key

      - name: Stop Service, Backup and Cleanup
        run: |
          ssh -p 18281 -i ssh_key -o StrictHostKeyChecking=no deploy@lemonsquizy.com "
            # Marker für Restore löschen, falls vom letzten Mal noch da
            rm -f /home/iss14/.restore_info

            # 1. Service stoppen (falls aktiv)
            if sudo systemctl is-active iss14; then
              sudo systemctl stop iss14
              echo 'ISS14 was running. Stopped ISS14'
            fi

            # 2. Backup Logik
            # Wir prüfen, ob das Server-Verzeichnis überhaupt existiert
            if [ -d /home/iss14/server ]; then
                echo 'Checking for files to backup...'
                cd /home/iss14/server
                
                FILES_TO_BACKUP=\"\"
                
                # Prüfen ob config existiert
                if [ -f \"server_config.toml\" ]; then
                    FILES_TO_BACKUP=\"\$FILES_TO_BACKUP server_config.toml\"
                fi
                
                # Prüfen ob preferences db existiert
                if [ -f \"data/preferences.db\" ]; then
                    FILES_TO_BACKUP=\"\$FILES_TO_BACKUP data/preferences.db\"
                fi
                
                # Wenn mindestens eine Datei gefunden wurde: Zippen
                if [ -n \"\$FILES_TO_BACKUP\" ]; then
                    mkdir -p /home/iss14/backup
                    TIMESTAMP=\$(date +%Y%m%d_%H%M%S)
                    BACKUP_PATH=\"/home/iss14/backup/\$TIMESTAMP.zip\"
                    
                    echo \"Backing up to \$BACKUP_PATH\"
                    zip -r \$BACKUP_PATH \$FILES_TO_BACKUP
                    
                    # WICHTIG: Pfad speichern für den Restore-Schritt
                    echo \"\$BACKUP_PATH\" > /home/iss14/.restore_info
                else
                    echo 'No config or database files found to backup.'
                fi
                
                # Verzeichnis verlassen, damit wir es gleich löschen können
                cd ..
            fi

            # 3. Aufräumen (Clean Install vorbereiten)
            mkdir -p /home/iss14/server
            echo 'Cleaning server directory...'
            rm -rf /home/iss14/server/*
          "

      - name: Copy Zip to Server
        run: |
          scp -P 18281 -i ssh_key ./downloaded-artifact/SS14.Server_linux-x64.zip deploy@lemonsquizy.com:/home/iss14/server/
        
      - name: Unzip and Start Service
        run: |
          ssh -p 18281 -i ssh_key -o StrictHostKeyChecking=no deploy@lemonsquizy.com "
            cd /home/iss14/server
            
            # 1. Neuen Server entpacken (bringt Standard-Configs mit)
            echo 'Unzipping new server build...'
            unzip -o SS14.Server_linux-x64.zip
            
            # 2. Backup wiederherstellen (überschreibt Standard-Configs mit alten Daten)
            if [ -f /home/iss14/.restore_info ]; then
                RESTORE_FILE=\$(cat /home/iss14/.restore_info)
                
                if [ -f \"\$RESTORE_FILE\" ]; then
                    echo \"RESTORING CONFIG/DB FROM: \$RESTORE_FILE\"
                    # -o (overwrite) ist wichtig, damit die leere Config vom neuen Build überschrieben wird
                    unzip -o \"\$RESTORE_FILE\"
                else
                    echo \"Error: Backup file defined but not found on disk!\"
                fi
                
                # Info-Datei aufräumen
                rm /home/iss14/.restore_info
            else
                echo 'No backup marker found. This seems to be a fresh install or nothing was backed up.'
            fi
            
            # 3. Service starten
            sudo systemctl start ISS14
            echo 'ISS14 started'
          "